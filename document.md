### 阅前提要

由于模块作者精力有限，不会主动适配不常用或者自己不用的软件  
提交 Issue 时请给出应用内截图、应用包名、必需的 Activity 适配信息和具体适配要求  
Pull Request 前建议在本地进行验证，提交时确保已填写 [应用适配列表](list.csv)、[更新日志](changelog.md)

模块对于部分软件可能无法生效

你可以在这里获取针对特定应用的[一些经验](https://github.com/Ianzb/MiNavBarImmerse/discussions)，并分享你的经验

<br>

# 工作原理

模块通过替换位于 `/data/system/` 路径下的 `cloudFeature_navigation_bar_immersive_rules_list.json` 来应用模块内的自定义规则

模块的自定义规则位于仓库内的 [immerse_rules.json](/module/immerse_rules.json)，该文件基于系统的源文件进行修改和添加自定义规则所创建

新版配置文件为JSON格式，支持更灵活的沉浸式规则配置。

<br>

# 开始适配

## 配置文件基本结构

```json5
{
  "dataVersion": "251104",
  "modules": "navigation_bar_immersive_application_config_new",
  "modifyApps": "modifyApps",
  "NBIRules": {
    "应用包名": {
      "name": "应用名称（模块为便于管理和区分自行添加的项目，不影响系统和模块运行）",
      "enable": true,
      //"enable31": true,
      //"disableVersionCode": null,
      "activityRules": {
        "Activity名称": {
          "mode": "适配模式",
          "color": "颜色值"
          //"sf_sampling_mode": "SF采样模式",
          //"dialogMode": "对话框模式",
          //"popupMode": "弹窗模式",
          //"appNavColorDisabled": "禁用应用导航栏颜色",
          //"viewRules": [
          //  {
          //    "viewName": "视图名称",
          //    "iD": "视图ID"
          //  }
          //]
        }
      }
    }
  }
}
```
<br>

## 应用级别配置选项

| 字段名                  | 类型    | 可选值           | 默认值  | 说明               |
|------------------------|---------|-----------------|---------|-------------------|
| **name**               | string  | 任意字符串       | -       | 应用显示名称（仅用于方便模块管理） |
| **enable**             | boolean | `true`, `false` | `false` | 基础启用标志            |
| **enable31**           | boolean | `true`, `false` | `false` | 特殊启用标志            |
| **disableVersionCode** | long    | 数字或 `null`      | `null`  | 当应用版本号大于等于此值时禁用规则 |

**启用逻辑说明：**

```javascript
// 最终启用状态 = enable OR enable31
```

- 即：只要有一个为 true 就启用，两个都为 false 才禁用
- 实际上，二者无任何区别（暂未确认）

<br>

## Activity 级别配置选项

### mode（沉浸模式）

| 值            | 名称     | 说明                  |
|--------------|--------|---------------------|
| **-1 (255)** | 自动模式   | 未配置规则，由系统算法自动检测适配   |
| **0**        | 禁用模式   | 明确禁用自动沉浸，保持应用原有样式   |
| **1**        | 取色模式   | 启用沉浸，使用 color 字段或视图采样 |
| **2**        | 强制沉浸模式 | 强制隐藏导航栏（完全沉浸）       |

### color（导航栏颜色）

>在本模块的配置文件中，为方便使用，可以在 color 项填写更常见的 16 进制 RGBA 格式或 RGB 格式字符串，模块在构建时会自动转换格式

| 类型                 | 示例值       | 对应颜色        | 说明                |
|---------------------|-------------|-----------------|---------------------|
| **特殊值**          | `1`         | -               | 系统自动检测底部颜色 |
| **ARGB 32位整数值** | `-16777216` | 黑色 (0xFF000000) | 直接设置导航栏为指定颜色 |
|                 | `-1`        | 白色 (0xFFFFFFFF) | 直接设置导航栏为指定颜色     |
| **未设置或null**    | -           | -               | 使用默认逻辑             |

### sf_sampling_mode（SF采样模式）

| 值       | 名称       | 说明                     |
|---------|----------|------------------------|
| **0**   | 自动模式（默认） | 由系统自动判断是否需要启用SF采样      |
| **1**   | 强制启用模式   | 强制启用SurfaceFlinger屏幕采样 |
| **255** | 强制禁用模式   | 强制禁用SF采样               |

### dialogMode（对话框模式）

| 值     | 名称         | 说明               |
|-------|------------|------------------|
| **0** | 禁用模式       | 对话框窗口禁用沉浸适配      |
| **1** | 视图采样模式（默认） | 对话框启用沉浸，使用视图采样取色 |
| **2** | SF 采样模式     | 对话框启用沉浸，使用 SF 采样取色 |

### popupMode（弹窗模式）

| 值     | 名称         | 说明              |
|-------|------------|-----------------|
| **0** | 禁用模式       | 弹窗窗口禁用沉浸适配      |
| **1** | 视图采样模式（默认） | 弹窗启用沉浸，使用视图采样取色 |
| **2** | SF采样模式     | 弹窗启用沉浸，使用SF采样取色 |

### appNavColorDisabled（禁用应用导航栏颜色）

| 值     | 名称      | 说明              |
|-------|---------|-----------------|
| **0** | 不禁用（默认） | 允许该应用的自动导航栏颜色适配 |
| **1** | 禁用      | 禁用该应用的自动导航栏颜色适配 |

### viewRules（视图规则数组）

- 暂不清楚具体效果，不建议使用

| 字段名          | 类型     | 说明          |
|--------------|--------|-------------|
| **viewName** | string | 需要特殊处理的视图名称 |
| **iD**       | string | 需要特殊处理的视图 ID |

<br>


## 优先级说明

### 1. 启用优先级

```
应用级别 enable/enable31 > Activity 级别 mode > 具体规则
```

### 2. 颜色来源优先级（当 mode=1 时）

```
color 字段指定（color≠1）> SF采样（sf_sampling_mode=1）> 视图采样（color=1）> 系统默认
```

### 3. 规则匹配优先级

```
具体 Activity 名称 > 通配符 "*"
```

### 4. 特殊情况处理

- 如果同时配置了 `mode=0`（禁用）和 `sf_sampling_mode=1`，SF采样优先
- `dialogMode` 和 `popupMode` 仅对相应类型窗口生效

## 推荐适配策略

### 快速适配方案

对于大多数应用，推荐使用以下组合：

1. **全局取色 + 主界面默认**
   ```json
   "*": { "mode": 1, "color": 1 },
   "MainActivity": { "mode": 0 }
   ```

2. **全局自动 + 特定页面优化**
   ```json
   "*": { "mode": -1 },
   "WebViewActivity": { "mode": 1, "sf_sampling_mode": 1 }
   ```

### 模式选择指南

#### mode=1（取色模式）适用场景：

- 有固定底栏的页面（如标签栏、工具栏）
- 颜色相对固定的界面
- 需要精确颜色匹配的场景

#### mode=2（强制沉浸模式）适用场景：

- 需要上下滑动的信息流页面（微博、知乎等）
- 搜索、设置等无底部固定控件的页面
- 需要最大化显示面积的场景

#### mode=0（禁用模式）适用场景：

- 应用自身已有良好适配
- 有兼容性问题的页面
- 视频播放等全屏场景

#### mode=-1（自动模式）适用场景：

- 不确定最佳适配方式的页面
- 希望系统智能判断的场景
- 作为默认回退方案

### SF采样模式选择

- **普通界面**：使用默认值 `0`
- **复杂动态界面**（如视频号、网页）：使用 `1`
- **有兼容性问题**：使用 `255`

<br>

# 调试技巧

### 悬浮效果预览

在 HyperOS 的关机菜单，小白条会自动隐藏，此时悬浮效果会强制生效，可以通过这种方式初步判断指定A ctivity 能否适配悬浮样式

<br>

# 提交适配

## 准备工作

1. 安装并测试应用的各种页面
2. 确定需要适配的应用包名和Activity名称
3. 选择合适的适配模式组合
4. 如果需要取色，确定合适的颜色值

## 修改配置文件

1. 在 `module/immersive_rules.json` 中添加或修改规则
2. 更新 `list.csv` 记录适配信息
3. 在 `changelog.md` 中添加更新说明

## 验证要求

- 在本地设备上测试所有适配页面的效果
- 确保不会造成界面异常或功能问题
- 测试对话框和弹窗场景
- 截图记录适配前后的对比

<br>

# 常见问题

### 配置为什么不生效？

1. 应用强制设置了导航栏样式（使用 `appNavColorDisabled: 1` 尝试）
2. Activity名称不正确
3. 被系统云控覆盖
4. 配置文件格式错误
5. 应用版本号超过 `disableVersionCode`

### 如何获取 Activity 名称？

可以使用以下方法：

1. 开发者选项中的"显示布局边界"
2. ADB命令：`adb shell dumpsys activity activities`
3. 第三方Activity检测工具
4. 查看应用日志输出

### enable 和 enable31有什么区别？

根据源代码，两者是OR关系：

- 只要有一个为`true`，该应用的沉浸功能就启用
- 实际使用时建议只使用`enable`

### 通配符 `*` 会覆盖具体Activity规则吗？

不会，具体Activity规则优先级高于通配符规则。系统会优先匹配具体的Activity名称，如果没有匹配到，才会使用通配符规则。

### `color=1` 和其他颜色值有什么区别？

- `color: 1`：触发自动视图采样，系统分析界面底部颜色
- `color: 其他整数值`：直接使用该颜色值，不进行采样
- 不设置color字段：使用默认逻辑

### SF 采样和视图采样有什么区别？

- **视图采样**：分析应用视图树的颜色，精度高但性能开销大
- **SF采样**：直接从屏幕像素采样，性能好但可能不够精确
- 复杂界面推荐使用SF采样（`sf_sampling_mode: 1`）

<br>

# 重要提示：

- 适配前请充分测试各种场景（正常界面、对话框、弹窗）
- 记录所有修改和测试结果
- 对于复杂的应用，建议分步骤适配
- 如果遇到无法解决的问题，可以先使用 `mode: -1` 让系统自动处理
- 提交PR时请确保配置格式正确，所有字段值有效